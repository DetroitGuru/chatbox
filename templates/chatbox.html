<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/thegoodmonolith" rel="stylesheet">
    <title>Chatbox Widget</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: TheGoodMonolith, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #000; padding: 1rem; }
        .chatbox { width: 100%; max-width: 42rem; background: #000; color: #0f0; border: 2px ridge #0f0; border-radius: 4px; overflow: hidden; }
        .chatbox-header { padding: 1rem; }
        .name-input { width: 100%; padding: 0.5rem; background: #000; border: 1px inset #0f0; color: #0f0; border-radius: 0.25rem; margin-bottom: 0.5rem; }
        .toolbar { display: flex; gap: 0.25rem; margin-bottom: 0.5rem; }
        .toolbar-button { background: black; border: none; color: #0f0; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem; }
        .toolbar-button:hover { background: black; color: #4ade80; }
        .spinning { animation: spin 1s linear infinite; }
        .message-form { display: flex; gap: 0.5rem; }
        .message-input { flex: 1; min-height: 60px; padding: 0.5rem; background: #000; border: 1px inset #0f0; color: #0f0; border-radius: 0.25rem; resize: vertical; white-space: pre-wrap; word-wrap: break-word; max-width: 100%; overflow-x: auto; }
        .send-button { padding: 0.5rem; background-color: black; border: none; color: #0f0; cursor: pointer; }
        .send-button:hover { background: black; color: #4ade80; }
        .visitor-count { font-size: .9rem; text-align: center; opacity: 0; line-height: 1.5em; transition: .2s all ease; color: rgba(34, 197, 94, 0.5); }
        .visitor-count:before { content: ''; display: inline-block; width: .6rem; height: .6rem; border-radius: .3rem; background-color: #0faa0f; margin-right: .2rem; vertical-align: middle; margin-bottom: 2px; box-shadow: 0 0 2px #004701; }
        .chatbox-content { padding: 1rem; padding-top: 0; max-height: 400px; overflow-y: auto; }
        .refresh-container { display: flex; justify-content: center; margin-bottom: 1rem; }
        .messages { display: flex; flex-direction: column; gap: 1rem; max-height: 100%; overflow-y: auto; }
        .message { display: flex; flex-direction: column; gap: 0.25rem; }
        .message-header { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .username { font-weight: bold; }
        .dev-username { color: red; font-weight: bold; }
        .timestamp { color: rgba(34, 197, 94, 0.5); font-size: 0.75rem; }
        .message-content { font-size: 0.875rem; }
        .dev-message-content { color: red; font-size: 0.875rem; }
        .chatbox-footer { padding: 1rem; text-align: center; font-size: 0.75rem; color: rgba(34, 197, 94, 0.5); }
        ::placeholder { color: rgba(34, 197, 94, 0.5); }
    </style>
</head>
<body>
    <div class="chatbox">
        <div class="chatbox-header">
            <input type="text" class="name-input" placeholder="Name" id="nameInput" aria-label="Enter your name">
            <div class="toolbar">
                <button class="toolbar-button" title="Bold" id="boldButton" aria-label="Bold text">
                    <i class="fas fa-bold"></i>
                </button>
                <button class="toolbar-button" title="Italic" id="italicButton" aria-label="Italic text">
                    <i class="fas fa-italic"></i>
                </button>
                <button class="toolbar-button" title="Strikethrough" id="strikethroughButton" aria-label="Strikethrough text">
                    <i class="fas fa-strikethrough"></i>
                </button>
            </div>
            <form class="message-form" id="messageForm">
                <div id="messageInput" class="message-input" contenteditable="true" placeholder="Message" aria-label="Enter your message"></div>
                <button class="send-button" type="submit" aria-label="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
        <div class="visitor-count" style="opacity: 0.75;">
            <span id="visitorcount">7</span>
            <span id="now_online">now online</span>
        </div>
        <div class="chatbox-content">
            <div class="refresh-container">
                <button class="toolbar-button" id="refreshButton" aria-label="Refresh messages">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                </button>
            </div>
            <div class="messages" id="messages" aria-live="polite"></div>
        </div>
        <div class="chatbox-footer">MOKMOBI Chatbox</div>
    </div>

<script>
// Fetch the messages from the Flask backend
function fetchMessages() {
    fetch('/messages')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch messages');
            }
            return response.json();
        })
        .then(data => renderMessages(data))
        .catch(error => console.error("Error fetching messages:", error));
}

// Fetch the visitor count from the backend
function fetchVisitorCount() {
    fetch('/visitor_count')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch visitor count');
            }
            return response.json();
        })
        .then(data => {
            const visitorCountElement = document.getElementById('visitorcount');
            if (visitorCountElement) {
                visitorCountElement.textContent = data.visitor_count;
            }
        })
        .catch(error => console.error("Error fetching visitor count:", error));
}

// Update visitor count every 5 seconds
setInterval(fetchVisitorCount, 5000);

// Render messages in the chatbox
function renderMessages(messages) {
    const messagesContainer = document.getElementById('messages');
    if (messagesContainer) {
        messagesContainer.innerHTML = messages
            .map(msg => {
                const usernameClass = msg.username === 'MOKMOBI (Dev)' ? 'dev-username' : '';
                const messageContentClass = msg.username === 'MOKMOBI (Dev)' ? 'dev-message-content' : '';
                const formattedTimestamp = new Date(msg.timestamp).toLocaleString();

                return `
                    <div class="message">
                        <div class="message-header">
                            <span class="username ${usernameClass}">${msg.username}</span>
                            <span class="timestamp">${formattedTimestamp}</span>
                        </div>
                        <p class="message-content ${messageContentClass}">${msg.content}</p>
                    </div>
                `;
            })
            .join('');
    }
}

// Handle message form submission
function handleMessageSubmit(event) {
    event.preventDefault(); // Prevent page refresh on submit

    const username = document.getElementById('nameInput').value.trim();
    const content = document.getElementById('messageInput').innerHTML.trim();

    if (!username || !content) {
        alert("Please enter both your name and a message.");
        return;
    }

    const messageData = { username, content };

    fetch('/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(messageData)
    })
    .then(response => {
        if (response.ok) {
            fetchMessages(); // Refresh messages after sending
            document.getElementById('messageInput').innerText = ''; // Clear input after sending
        } else {
            console.error("Failed to send message");
        }
    })
    .catch(error => console.error("Error sending message:", error));
}

// Event listeners for submitting the form and refreshing messages
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('messageForm').addEventListener('submit', handleMessageSubmit);
    document.getElementById('refreshButton').addEventListener('click', function() {
        fetchMessages();
        document.getElementById('refreshIcon').classList.add('spinning');
        setTimeout(function() {
            document.getElementById('refreshIcon').classList.remove('spinning');
        }, 1000);
    });

    // Fetch initial messages and set up event listeners
    fetchMessages();
    fetchVisitorCount();
});
</script>
</body>
</html>
